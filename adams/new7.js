const { adams } = require("../Ibrahim/adams");
const axios = require("axios");

// ================================
// GLOBAL PHONE TRACKER - REPLY MODE
// ================================

const globalCountries = {
    "1": { name: "United States/Canada", flag: "üá∫üá∏üá®üá¶", region: "North America", carriers: ["Verizon", "AT&T", "T-Mobile", "Rogers", "Bell"] },
    "44": { name: "United Kingdom", flag: "üá¨üáß", region: "Europe", carriers: ["EE", "O2", "Vodafone", "Three"] },
    "33": { name: "France", flag: "üá´üá∑", region: "Europe", carriers: ["Orange", "SFR", "Bouygues", "Free"] },
    "49": { name: "Germany", flag: "üá©üá™", region: "Europe", carriers: ["Deutsche Telekom", "Vodafone", "O2"] },
    "39": { name: "Italy", flag: "üáÆüáπ", region: "Europe", carriers: ["TIM", "Vodafone", "WindTre"] },
    "34": { name: "Spain", flag: "üá™üá∏", region: "Europe", carriers: ["Movistar", "Vodafone", "Orange"] },
    "31": { name: "Netherlands", flag: "üá≥üá±", region: "Europe", carriers: ["KPN", "VodafoneZiggo", "T-Mobile"] },
    "7": { name: "Russia", flag: "üá∑üá∫", region: "Europe/Asia", carriers: ["MTS", "Beeline", "MegaFon"] },
    "86": { name: "China", flag: "üá®üá≥", region: "Asia", carriers: ["China Mobile", "China Unicom", "China Telecom"] },
    "91": { name: "India", flag: "üáÆüá≥", region: "Asia", carriers: ["Jio", "Airtel", "Vi", "BSNL"] },
    "81": { name: "Japan", flag: "üáØüáµ", region: "Asia", carriers: ["NTT DoCoMo", "SoftBank", "au"] },
    "82": { name: "South Korea", flag: "üá∞üá∑", region: "Asia", carriers: ["SK Telecom", "KT", "LG U+"] },
    "65": { name: "Singapore", flag: "üá∏üá¨", region: "Asia", carriers: ["Singtel", "StarHub", "M1"] },
    "60": { name: "Malaysia", flag: "üá≤üáæ", region: "Asia", carriers: ["Maxis", "Celcom", "Digi"] },
    "66": { name: "Thailand", flag: "üáπüá≠", region: "Asia", carriers: ["AIS", "dtac", "TrueMove"] },
    "84": { name: "Vietnam", flag: "üáªüá≥", region: "Asia", carriers: ["Viettel", "VinaPhone", "MobiFone"] },
    "62": { name: "Indonesia", flag: "üáÆüá©", region: "Asia", carriers: ["Telkomsel", "Indosat", "XL Axiata"] },
    "63": { name: "Philippines", flag: "üáµüá≠", region: "Asia", carriers: ["Globe", "Smart", "DITO"] },
    "92": { name: "Pakistan", flag: "üáµüá∞", region: "Asia", carriers: ["Jazz", "Telenor", "Zong"] },
    "94": { name: "Sri Lanka", flag: "üá±üá∞", region: "Asia", carriers: ["Dialog", "Mobitel", "Hutch"] },
    "880": { name: "Bangladesh", flag: "üáßüá©", region: "Asia", carriers: ["Grameenphone", "Robi", "Banglalink"] },
    "966": { name: "Saudi Arabia", flag: "üá∏üá¶", region: "Asia", carriers: ["STC", "Mobily", "Zain"] },
    "971": { name: "UAE", flag: "üá¶üá™", region: "Asia", carriers: ["Etisalat", "du"] },
    "90": { name: "Turkey", flag: "üáπüá∑", region: "Europe/Asia", carriers: ["Turkcell", "Vodafone", "T√ºrk Telekom"] },
    "254": { name: "Kenya", flag: "üá∞üá™", region: "Africa", carriers: ["Safaricom", "Airtel", "Telkom"] },
    "234": { name: "Nigeria", flag: "üá≥üá¨", region: "Africa", carriers: ["MTN", "Airtel", "Glo", "9mobile"] },
    "27": { name: "South Africa", flag: "üáøüá¶", region: "Africa", carriers: ["Vodacom", "MTN", "Cell C"] },
    "20": { name: "Egypt", flag: "üá™üá¨", region: "Africa", carriers: ["Orange", "Vodafone", "Etisalat"] },
    "212": { name: "Morocco", flag: "üá≤üá¶", region: "Africa", carriers: ["Maroc Telecom", "Orange", "inwi"] },
    "233": { name: "Ghana", flag: "üá¨üá≠", region: "Africa", carriers: ["MTN", "Vodafone", "AirtelTigo"] },
    "61": { name: "Australia", flag: "üá¶üá∫", region: "Oceania", carriers: ["Telstra", "Optus", "Vodafone"] },
    "64": { name: "New Zealand", flag: "üá≥üáø", region: "Oceania", carriers: ["Spark", "Vodafone", "2degrees"] },
    "55": { name: "Brazil", flag: "üáßüá∑", region: "South America", carriers: ["Vivo", "TIM", "Claro", "Oi"] },
    "54": { name: "Argentina", flag: "üá¶üá∑", region: "South America", carriers: ["Movistar", "Claro", "Personal"] },
    "52": { name: "Mexico", flag: "üá≤üáΩ", region: "Central America", carriers: ["Telcel", "AT&T", "Movistar"] }
};

function analyzePhoneNumber(phoneNumber) {
    const cleanNumber = phoneNumber.replace(/\D/g, '');
    
    for (let i = 4; i >= 1; i--) {
        const code = cleanNumber.substring(0, i);
        if (globalCountries[code]) {
            const country = globalCountries[code];
            const localNumber = cleanNumber.substring(i);
            
            return {
                countryCode: code,
                country: country.name,
                flag: country.flag,
                region: country.region,
                carriers: country.carriers,
                localNumber: localNumber,
                fullNumber: `+${code} ${localNumber}`,
                isValid: localNumber.length >= 8 && localNumber.length <= 12
            };
        }
    }
    
    return null;
}

function extractPhoneFromJid(jid) {
    const phoneMatch = jid.match(/(\d+)/);
    return phoneMatch ? phoneMatch[1] : null;
}

// Track command - can use number or reply to message
adams({
    nomCom: "track",
    aliases: ["tr"],
    categorie: "New",
    reaction: "üåç"
}, async (dest, zk, commandOptions) => {
    const { arg, repondre, ms } = commandOptions;

    let phoneNumber = null;

    // Check if replying to a message
    if (ms.quoted) {
        const quotedJid = ms.quoted.key.participant || ms.quoted.key.remoteJid;
        phoneNumber = extractPhoneFromJid(quotedJid);
    }
    
    // If no reply or no phone from reply, check arguments
    if (!phoneNumber && arg[0]) {
        phoneNumber = arg.join("").replace(/\s+/g, "");
    }

    if (!phoneNumber) {
        return repondre(`üåç *GLOBAL PHONE TRACKER*

üì± Usage: 
‚Ä¢ track +1234567890
‚Ä¢ Reply to any message + type "track"

*Examples:*
‚Ä¢ track +254712345678  
‚Ä¢ track +44123456789

üí° Works with all countries!`);
    }

    try {
        const analysis = analyzePhoneNumber(phoneNumber);
        
        if (!analysis) {
            return repondre(`‚ùå Could not identify phone number: ${phoneNumber}

Please provide a valid international format.
Example: +1234567890`);
        }

        const result = `üåç *PHONE TRACKER RESULTS*

üì± *Number:* ${analysis.fullNumber}
${analysis.flag} *Country:* ${analysis.country}
üó∫Ô∏è *Region:* ${analysis.region}
üè∑Ô∏è *Code:* +${analysis.countryCode}
‚úÖ *Valid:* ${analysis.isValid ? "Yes" : "No"}

üè¢ *Major Carriers:*
${analysis.carriers.map(carrier => `‚Ä¢ ${carrier}`).join('\n')}

‚ö° *BWM XMD Global Tracker*`;

        await repondre(result);

    } catch (error) {
        console.error("Phone tracking error:", error);
        return repondre("‚ùå Error analyzing phone number. Please try again.");
    }
});

// ================================
// FILE CREATOR - REPLY MODE
// ================================

const githubFormats = {
    "mp3": { mime: "audio/mpeg", ext: ".mp3", desc: "Audio file", icon: "üéµ" },
    "mp4": { mime: "video/mp4", ext: ".mp4", desc: "Video file", icon: "üé•" },
    "js": { mime: "text/javascript", ext: ".js", desc: "JavaScript", icon: "üìú" },
    "html": { mime: "text/html", ext: ".html", desc: "HTML file", icon: "üåê" },
    "json": { mime: "application/json", ext: ".json", desc: "JSON file", icon: "üìã" }
};

function createFileContent(text, format) {
    const timestamp = new Date().toISOString();
    
    switch (format) {
        case "js":
            return `// Generated by BWM XMD
// Created: ${timestamp}

const content = \`${text.replace(/`/g, '\\`')}\`;

console.log(content);

module.exports = {
    content: content,
    timestamp: "${timestamp}",
    generator: "BWM XMD"
};`;

        case "html":
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BWM XMD Generated File</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px;
            line-height: 1.6;
        }
        .header { 
            background: #f4f4f4; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 20px;
        }
        .content { 
            background: #f9f9f9; 
            padding: 15px; 
            border-radius: 8px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>BWM XMD Generated Content</h1>
        <p><strong>Created:</strong> ${new Date(timestamp).toLocaleString()}</p>
        <p><strong>Generator:</strong> BWM XMD File Creator</p>
    </div>
    <div class="content">${text.replace(/\n/g, '<br>')}</div>
</body>
</html>`;

        case "json":
            return JSON.stringify({
                content: text,
                metadata: {
                    created: timestamp,
                    generator: "BWM XMD",
                    format: "json",
                    version: "1.0"
                }
            }, null, 2);

        default:
            return text;
    }
}

// JavaScript file creator
adams({
    nomCom: "js",
    categorie: "New",
    reaction: "üìú"
}, async (dest, zk, commandOptions) => {
    const { repondre, ms } = commandOptions;

    if (!ms.quoted) {
        return repondre("‚ùå Reply to a message to convert it to JavaScript file");
    }

    try {
        const quotedText = ms.quoted.message?.conversation || 
                          ms.quoted.message?.extendedTextMessage?.text || 
                          "No text content";

        const filename = `bwm_${Date.now()}.js`;
        const fileContent = createFileContent(quotedText, "js");
        const fileBuffer = Buffer.from(fileContent, 'utf8');

        await zk.sendMessage(dest, {
            document: fileBuffer,
            fileName: filename,
            mimetype: githubFormats.js.mime,
            caption: `üìú *JavaScript File Created*

üìÅ ${filename}
üìä ${fileBuffer.length} bytes
‚úÖ GitHub ready!

*Content:* ${quotedText.substring(0, 50)}${quotedText.length > 50 ? '...' : ''}`
        }, { quoted: ms });

    } catch (error) {
        console.error("JS file creation error:", error);
        return repondre("‚ùå Error creating JavaScript file");
    }
});

// HTML file creator
adams({
    nomCom: "html",
    categorie: "New", 
    reaction: "üåê"
}, async (dest, zk, commandOptions) => {
    const { repondre, ms } = commandOptions;

    if (!ms.quoted) {
        return repondre("‚ùå Reply to a message to convert it to HTML file");
    }

    try {
        const quotedText = ms.quoted.message?.conversation || 
                          ms.quoted.message?.extendedTextMessage?.text || 
                          "No text content";

        const filename = `bwm_${Date.now()}.html`;
        const fileContent = createFileContent(quotedText, "html");
        const fileBuffer = Buffer.from(fileContent, 'utf8');

        await zk.sendMessage(dest, {
            document: fileBuffer,
            fileName: filename,
            mimetype: githubFormats.html.mime,
            caption: `üåê *HTML File Created*

üìÅ ${filename}
üìä ${fileBuffer.length} bytes
‚úÖ GitHub ready!

*Content:* ${quotedText.substring(0, 50)}${quotedText.length > 50 ? '...' : ''}`
        }, { quoted: ms });

    } catch (error) {
        console.error("HTML file creation error:", error);
        return repondre("‚ùå Error creating HTML file");
    }
});

// JSON file creator
adams({
    nomCom: "json",
    categorie: "New",
    reaction: "üìã" 
}, async (dest, zk, commandOptions) => {
    const { repondre, ms } = commandOptions;

    if (!ms.quoted) {
        return repondre("‚ùå Reply to a message to convert it to JSON file");
    }

    try {
        const quotedText = ms.quoted.message?.conversation || 
                          ms.quoted.message?.extendedTextMessage?.text || 
                          "No text content";

        const filename = `bwm_${Date.now()}.json`;
        const fileContent = createFileContent(quotedText, "json");
        const fileBuffer = Buffer.from(fileContent, 'utf8');

        await zk.sendMessage(dest, {
            document: fileBuffer,
            fileName: filename,
            mimetype: githubFormats.json.mime,
            caption: `üìã *JSON File Created*

üìÅ ${filename}
üìä ${fileBuffer.length} bytes
‚úÖ GitHub ready!

*Content:* ${quotedText.substring(0, 50)}${quotedText.length > 50 ? '...' : ''}`
        }, { quoted: ms });

    } catch (error) {
        console.error("JSON file creation error:", error);
        return repondre("‚ùå Error creating JSON file");
    }
});

// MP3 file creator (from audio messages)
adams({
    nomCom: "mp3",
    categorie: "New",
    reaction: "üéµ"
}, async (dest, zk, commandOptions) => {
    const { repondre, ms } = commandOptions;

    if (!ms.quoted) {
        return repondre("‚ùå Reply to an audio message to convert it to MP3 file");
    }

    try {
        if (!ms.quoted.message.audioMessage) {
            return repondre("‚ùå Please reply to an audio message");
        }

        const audioBuffer = await zk.downloadMediaMessage(ms.quoted);
        const filename = `bwm_audio_${Date.now()}.mp3`;
        const fileSize = (audioBuffer.length / 1024).toFixed(1);

        await zk.sendMessage(dest, {
            document: audioBuffer,
            fileName: filename,
            mimetype: githubFormats.mp3.mime,
            caption: `üéµ *MP3 File Created*

üìÅ ${filename}
üìä ${fileSize} KB
‚úÖ GitHub ready!

*Converted from audio message*`
        }, { quoted: ms });

    } catch (error) {
        console.error("MP3 file creation error:", error);
        return repondre("‚ùå Error creating MP3 file");
    }
});

// MP4 file creator (from video messages)
adams({
    nomCom: "mp4",
    categorie: "New",
    reaction: "üé•"
}, async (dest, zk, commandOptions) => {
    const { repondre, ms } = commandOptions;

    if (!ms.quoted) {
        return repondre("‚ùå Reply to a video message to convert it to MP4 file");
    }

    try {
        if (!ms.quoted.message.videoMessage) {
            return repondre("‚ùå Please reply to a video message");
        }

        const videoBuffer = await zk.downloadMediaMessage(ms.quoted);
        const filename = `bwm_video_${Date.now()}.mp4`;
        const fileSize = (videoBuffer.length / (1024 * 1024)).toFixed(1);

        await zk.sendMessage(dest, {
            document: videoBuffer,
            fileName: filename,
            mimetype: githubFormats.mp4.mime,
            caption: `üé• *MP4 File Created*

üìÅ ${filename}
üìä ${fileSize} MB
‚úÖ GitHub ready!

*Converted from video message*`
        }, { quoted: ms });

    } catch (error) {
        console.error("MP4 file creation error:", error);
        return repondre("‚ùå Error creating MP4 file");
    }
});

console.log("‚úÖ BWM XMD Reply System Loaded:");
console.log("üåç Phone Tracker - Reply or type number");
console.log("üìÅ File Creators - js, html, json, mp3, mp4");
console.log("üí° Just reply to any message and type the command!");
